generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id               String            @id @default(uuid())
  name             String
  cnpj             String?           @unique
  email            String?
  phone            String?
  settings         String            @default("{}")
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  activities       Activity[]
  auditLogs        AuditLog[]
  clients          Client[]
  contacts         Contact[]
  deadlines        Deadline[]
  documentVersions DocumentVersion[]
  documents        Document[]
  hearings         Hearing[]
  interactions     Interaction[]
  invoiceItems     InvoiceItem[]
  invoices         Invoice[]
  matters          Matter[]
  payments         Payment[]
  roles            Role[]
  tasks            Task[]
  templates        Template[]
  timeEntries      TimeEntry[]
  transactions     Transaction[]
  users            User[]

  @@map("tenants")
}

model User {
  id                    String            @id @default(uuid())
  tenantId              String
  fullName              String
  email                 String            @unique
  password              String
  role                  String
  isActive              Boolean           @default(true)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  activities            Activity[]
  auditLogs             AuditLog[]
  responsibleForClients Client[]          @relation("ResponsibleLawyer")
  uploadedVersions      DocumentVersion[] @relation("UploadedBy")
  uploadedDocuments     Document[]        @relation("UploadedBy")
  interactions          Interaction[]
  responsibleForMatters Matter[]          @relation("ResponsibleLawyer")
  assignedTasks         Task[]            @relation("AssignedTo")
  createdTemplates      Template[]        @relation("CreatedBy")
  timeEntries           TimeEntry[]
  tenant                Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  permissions String   @default("{}")
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("roles")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldData    String?
  newData    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, entityType])
  @@index([tenantId, userId])
  @@map("audit_logs")
}

model Client {
  id                  String        @id @default(uuid())
  tenantId            String
  type                String
  name                String
  cpfCnpj             String?
  email               String?
  phone               String?
  street              String?
  number              String?
  complement          String?
  neighborhood        String?
  city                String?
  state               String?
  zipCode             String?
  responsibleLawyerId String?
  status              String        @default("active")
  leadStage           String?       @default("new")
  tags                String?
  metadata            String        @default("{}")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  responsibleLawyer   User?         @relation("ResponsibleLawyer", fields: [responsibleLawyerId], references: [id])
  tenant              Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts            Contact[]
  documents           Document[]
  interactions        Interaction[]
  invoices            Invoice[]
  matters             Matter[]
  timeEntries         TimeEntry[]

  @@unique([tenantId, cpfCnpj])
  @@index([tenantId, status])
  @@index([tenantId, leadStage])
  @@index([tenantId, name])
  @@map("clients")
}

model Contact {
  id        String   @id @default(uuid())
  tenantId  String
  clientId  String
  name      String
  role      String?
  email     String?
  phone     String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

model Interaction {
  id          String   @id @default(uuid())
  tenantId    String
  clientId    String
  userId      String?
  type        String
  subject     String?
  description String?
  metadata    String   @default("{}")
  createdAt   DateTime @default(now())
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, clientId])
  @@index([tenantId, userId])
  @@map("interactions")
}

model Matter {
  id                  String      @id @default(uuid())
  tenantId            String
  clientId            String
  processNumber       String?
  title               String
  description         String?
  court               String?
  district            String?
  department          String?
  instance            String?
  practiceArea        String
  responsibleLawyerId String?
  status              String      @default("open")
  riskScore           Int?
  tags                String?
  metadata            String      @default("{}")
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  activities          Activity[]
  deadlines           Deadline[]
  documents           Document[]
  hearings            Hearing[]
  invoices            Invoice[]
  client              Client      @relation(fields: [clientId], references: [id])
  responsibleLawyer   User?       @relation("ResponsibleLawyer", fields: [responsibleLawyerId], references: [id])
  tenant              Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tasks               Task[]
  timeEntries         TimeEntry[]

  @@index([tenantId, status])
  @@index([tenantId, clientId])
  @@index([tenantId, responsibleLawyerId])
  @@index([tenantId, createdAt])
  @@map("matters")
}

model Task {
  id           String    @id @default(uuid())
  tenantId     String
  matterId     String?
  assignedToId String?
  title        String
  description  String?
  dueDate      DateTime?
  priority     String    @default("medium")
  status       String    @default("pending")
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  assignedTo   User?     @relation("AssignedTo", fields: [assignedToId], references: [id])
  matter       Matter?   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, matterId])
  @@index([tenantId, assignedToId])
  @@map("tasks")
}

model Deadline {
  id              String    @id @default(uuid())
  tenantId        String
  matterId        String
  title           String
  description     String?
  deadlineDate    DateTime
  alertDaysBefore Int       @default(3)
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  matter          Matter    @relation(fields: [matterId], references: [id], onDelete: Cascade)
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, deadlineDate])
  @@index([tenantId, isCompleted])
  @@index([tenantId, matterId])
  @@map("deadlines")
}

model Hearing {
  id          String   @id @default(uuid())
  tenantId    String
  matterId    String
  hearingDate DateTime
  type        String?
  location    String?
  attendees   String?
  notes       String?
  status      String   @default("scheduled")
  createdAt   DateTime @default(now())
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, matterId, hearingDate])
  @@map("hearings")
}

model Activity {
  id          String   @id @default(uuid())
  tenantId    String
  matterId    String
  userId      String?
  action      String
  description String?
  metadata    String   @default("{}")
  createdAt   DateTime @default(now())
  matter      Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([tenantId, matterId, createdAt])
  @@map("activities")
}

model Document {
  id           String            @id @default(uuid())
  tenantId     String
  matterId     String?
  clientId     String?
  name         String
  description  String?
  type         String?
  storagePath  String
  fileSize     Int?
  mimeType     String?
  version      Int               @default(1)
  isTemplate   Boolean           @default(false)
  tags         String?
  uploadedById String?
  metadata     String            @default("{}")
  createdAt    DateTime          @default(now())
  versions     DocumentVersion[]
  client       Client?           @relation(fields: [clientId], references: [id])
  matter       Matter?           @relation(fields: [matterId], references: [id])
  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy   User?             @relation("UploadedBy", fields: [uploadedById], references: [id])

  @@index([tenantId, matterId])
  @@index([tenantId, clientId])
  @@index([tenantId, createdAt])
  @@map("documents")
}

model DocumentVersion {
  id                 String   @id @default(uuid())
  tenantId           String
  documentId         String
  version            Int
  storagePath        String
  fileSize           Int?
  uploadedById       String?
  changesDescription String?
  createdAt          DateTime @default(now())
  document           Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy         User?    @relation("UploadedBy", fields: [uploadedById], references: [id])

  @@index([tenantId, documentId, createdAt])
  @@map("document_versions")
}

model Template {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  category    String?
  content     String
  variables   String   @default("[]")
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User?    @relation("CreatedBy", fields: [createdById], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, name])
  @@map("templates")
}

model TimeEntry {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  matterId    String?
  clientId    String?
  description String
  hours       Float
  hourlyRate  Float?
  billable    Boolean  @default(true)
  billed      Boolean  @default(false)
  invoiceId   String?
  date        DateTime
  createdAt   DateTime @default(now())
  client      Client?  @relation(fields: [clientId], references: [id])
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  matter      Matter?  @relation(fields: [matterId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@index([tenantId, userId, date])
  @@index([tenantId, clientId, matterId])
  @@index([tenantId, invoiceId])
  @@map("time_entries")
}

model Invoice {
  id            String        @id @default(uuid())
  tenantId      String
  clientId      String
  invoiceNumber String
  matterId      String?
  issueDate     DateTime
  dueDate       DateTime
  subtotal      Float
  taxAmount     Float         @default(0)
  totalAmount   Float
  status        String        @default("pending")
  paymentMethod String?
  paidAt        DateTime?
  notes         String?
  metadata      String        @default("{}")
  createdAt     DateTime      @default(now())
  items         InvoiceItem[]
  client        Client        @relation(fields: [clientId], references: [id])
  matter        Matter?       @relation(fields: [matterId], references: [id])
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments      Payment[]
  timeEntries   TimeEntry[]
  transactions  Transaction[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, clientId])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  tenantId    String
  invoiceId   String
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId])
  @@map("invoice_items")
}

model Payment {
  id            String   @id @default(uuid())
  tenantId      String
  invoiceId     String
  amount        Float
  paymentMethod String
  paymentDate   DateTime
  transactionId String?
  notes         String?
  createdAt     DateTime @default(now())
  invoice       Invoice  @relation(fields: [invoiceId], references: [id])
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId])
  @@index([tenantId, paymentDate])
  @@map("payments")
}

model Transaction {
  id          String   @id @default(uuid())
  tenantId    String
  type        String
  category    String
  description String
  amount      Float
  date        DateTime
  status      String   @default("paid")
  invoiceId   String?
  createdAt   DateTime @default(now())
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, date])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@map("transactions")
}
